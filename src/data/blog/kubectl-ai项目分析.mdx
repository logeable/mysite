---
title: kubectl-aié¡¹ç›®åˆ†æ
publishDate: 2025-05-28T10:04:17+08:00
author: logeable
description: kubectl-ai èƒ½å¤ŸæŠŠç”¨æˆ·è¾“å…¥è½¬åŒ–ä¸º Kubernetes æ“ä½œï¼Œä½¿ Kubernetes ç®¡ç†æ›´åŠ å‡†ç¡®å’Œé«˜æ•ˆï¼Œæ˜¾è‘—é™ä½å‘½ä»¤è®°å¿†å’Œæ“ä½œé—¨æ§›ã€‚
tags: ["kubectl", "kubenertes", "AI", "MCP"]
---
import Mermaid from "@components/Mermaid.astro";

## é¡¹ç›®ç®€ä»‹

[kubectl-ai](https://github.com/GoogleCloudPlatform/kubectl-ai) æ˜¯ä¸€ä¸ªç»ˆç«¯è¿è¡Œçš„k8s agentå‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒèƒ½å¤Ÿè®©ç”¨æˆ·é€šè¿‡è‡ªç„¶è¯­è¨€å’Œk8sè¿›è¡Œäº¤äº’ã€‚
å®ç°åŸç†æ˜¯åˆ©ç”¨å¤§è¯­è¨€æ¨¡å‹åˆ†æç”¨æˆ·è¾“å…¥å¹¶è¿›è¡Œæ¨ç†ï¼Œç„¶åæŒ‰ç…§ç”¨æˆ·çš„æ„å›¾æ‰§è¡ŒåŒ¹é…çš„`kubectl`å‘½ä»¤ï¼Œæœ€åæŠŠç»“æœç»“æ„åŒ–çš„å±•ç¤ºç»™ç”¨æˆ·ã€‚

`kubectl-ai` é™¤äº†å¯ä»¥ä½œä¸ºå‘½ä»¤è¡Œå·¥å…·ä½¿ç”¨ï¼Œè¿˜å¯ä»¥ä½œä¸º [MCP](https://modelcontextprotocol.io/introduction) æœåŠ¡ä½¿ç”¨ï¼Œä»¥ä¾¿å°†k8säº¤äº’èƒ½åŠ›é›†æˆåˆ°å…¶å®ƒMCPå®¢æˆ·ç«¯å·¥å…·ä¸­ï¼ˆcursor, cherry studioç­‰ï¼‰ã€‚

å®ƒè¿˜æ”¯æŒhtmläº¤äº’æ¨¡å¼ï¼Œä½†æ˜¯ç›®å‰äº¤äº’ä½“éªŒå¹¶ä¸å¥½ï¼Œæ‰€ä»¥è¿™é‡Œä¸å±•å¼€ä»‹ç»ã€‚

**è§£å†³äº†ä»€ä¹ˆç—›ç‚¹**

1. kubectl å‘½ä»¤å¤šï¼Œå‚æ•°å¤šï¼Œæœ‰ä¸€å®šçš„è®°å¿†é—¨æ§›
2. k8s èµ„æºå¯¹è±¡å¤šï¼Œå¯¹è±¡å±æ€§å¤šï¼Œéœ€è¦èŠ±æ—¶é—´æŸ¥ç›¸å…³æ–‡æ¡£ï¼Œå­¦ä¹ æ•ˆç‡ä¸é«˜
3. å‘½ä»¤è¡Œä¸å…¶ä»–å¼€å‘å·¥å…·ä¹‹é—´ç¼ºä¹ç»Ÿä¸€çš„æ™ºèƒ½æ¥å£

k8s API æ˜¯å£°æ˜å¼çš„ï¼Œç”¨æˆ·åªéœ€è¦å£°æ˜æœŸæœ›çš„çŠ¶æ€ï¼Œä¸éœ€è¦æŒ‡å¯¼å¦‚ä½•å®ç°ã€‚ä½†æ˜¯ç”¨æˆ·åœ¨ä½¿ç”¨kubectlæ—¶è¿˜æ˜¯éœ€è¦ä¸€æ­¥ä¸€æ­¥æ‰§è¡Œå‘½ä»¤ï¼Œåšä¸åˆ°å£°æ˜å¼æ“ä½œã€‚
æœ‰äº†kubectl-aiå·¥å…·ï¼Œç”¨æˆ·åªéœ€è¦è¾“å…¥æƒ³è¦ä»€ä¹ˆï¼Œå·¥å…·ä¼šè‡ªåŠ¨æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶æŠŠç»“æœå±•ç¤ºç»™ç”¨æˆ·ï¼Œé€šè¿‡è‡ªç„¶è¯­è¨€äº¤äº’å‡ ä¹å¯ä»¥åšåˆ°å£°æ˜å¼æ“ä½œã€‚

---

## ä½¿ç”¨æ–¹æ³•

### äº¤äº’æ¨¡å¼
- git clone é¡¹ç›®ï¼Œé…ç½®ç¯å¢ƒå˜é‡åç›´æ¥æ‰§è¡Œ `go run` å‘½ä»¤è¿è¡Œç¨‹åº

è¿™é‡Œæˆ‘ç›´æ¥ä½¿ç”¨å…¼å®¹`openai`æ¥å£çš„[deepseek API](https://api-docs.deepseek.com/zh-cn/)ã€‚
```bash
export OPENAI_API_KEY=${KEY}
export OPENAI_ENDPOINT=https://api.deepseek.com

â¯ go run ./cmd/  --llm-provider openai  --model deepseek-chat

  Hey there, what can I help you with today?                                  


>>> æŸ¥çœ‹defaultä¸‹æœ‰å“ªäº›æœåŠ¡
  Running: kubectl get services -n default


  åœ¨  default  å‘½åç©ºé—´ä¸‹æœ‰ä»¥ä¸‹æœåŠ¡ï¼š                                         
                                                                              
  1. kubernetes                                                               
    â€¢ ç±»å‹:  ClusterIP                                                        
    â€¢ Cluster IP:  10.96.0.1                                                  
    â€¢ ç«¯å£:  443/TCP                                                          
    â€¢ ç”¨é€”: Kubernetes API æœåŠ¡çš„é»˜è®¤ ClusterIP æœåŠ¡ã€‚                        
  2. lab                                                                      
    â€¢ ç±»å‹:  NodePort                                                         
    â€¢ Cluster IP:  10.98.27.7                                                 
    â€¢ ç«¯å£:  80:31435/TCP                                                     
    â€¢ ç”¨é€”: é€šè¿‡ NodePort  31435  æš´éœ²æœåŠ¡ï¼Œå¤–éƒ¨å¯ä»¥é€šè¿‡èŠ‚ç‚¹ IP å’Œç«¯å£  31435 
    è®¿é—®ã€‚                                                                    
                                                                              
                                                                              
  å¦‚æœéœ€è¦è¿›ä¸€æ­¥æŸ¥çœ‹æŸä¸ªæœåŠ¡çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¯ä»¥å‘Šè¯‰æˆ‘ï¼ ğŸ˜Š    

>>> å°†labæœåŠ¡å¯¹åº”deploymentå‰¯æœ¬æ•°æå‡ä¸º5ä¸ª
  Running: kubectl get deployment -n default

  Running: kubectl scale deployment lab --replicas=5 -n default

  Do you want to proceed ?
  1) Yes
  2) Yes, and don't ask me again
  3) No
  Enter your choice (1,2,3): 1

  å·²å°†  lab  æœåŠ¡çš„ Deployment å‰¯æœ¬æ•°ä»  2  æå‡ä¸º  5                         
  ä¸ªã€‚å¦‚æœéœ€è¦éªŒè¯å‰¯æœ¬çŠ¶æ€ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š                                
                                                                              
    kubectl get pods -n default -l app=lab                                    
                                                                              
  æˆ–è€…ç›´æ¥æŸ¥çœ‹ Deployment çŠ¶æ€ï¼š                                              
                                                                              
    kubectl get deployment lab -n default                                     

  å¦‚æœéœ€è¦è¿›ä¸€æ­¥è°ƒæ•´æˆ–å…¶ä»–å¸®åŠ©ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼ ğŸš€                   

>>> å¸®æˆ‘ç¡®è®¤å‰¯æœ¬æ•°æ˜¯å¦è®¾ç½®å®Œæˆ
  Running: kubectl get deployment lab -n default -o jsonpath='{.status.readyReplicas}'


  ç¡®è®¤  lab  æœåŠ¡çš„ Deployment å‰¯æœ¬æ•°å·²æˆåŠŸè®¾ç½®ä¸º  5 ï¼Œå¹¶ä¸”æ‰€æœ‰å‰¯æœ¬å‡å·²å°±ç»ª ( 
  ReadyReplicas: 5 )ã€‚å¦‚æœéœ€è¦è¿›ä¸€æ­¥éªŒè¯æˆ–æ“ä½œï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ï¼ ğŸ˜Š             
```

- å¤§å®¶ä¹Ÿå¯ä»¥æŒ‰ç…§ä»“åº“è¯´æ˜ä¸­çš„æ–¹æ³•è¿›è¡Œå®‰è£…

    - **Quick Install (Linux & MacOS only)**

    ```bash
    curl -sSL https://raw.githubusercontent.com/GoogleCloudPlatform/kubectl-ai/main/install.sh | bash
    ```

    - æˆ–è€…ä» [releases page](https://github.com/GoogleCloudPlatform/kubectl-ai/releases/latest) ä¸‹è½½

    è§£å‹å¹¶æ”¾åˆ°åˆé€‚çš„ç›®å½•

### MCPæ¨¡å¼

è¿™é‡Œä»¥`Cherry Studio`ä¸ºä¾‹ï¼Œé…ç½®MCPæœåŠ¡ã€‚
![kubectl-ai-mcp-cherry-studio-config](src/assets/blog-images/kubectl-aié¡¹ç›®åˆ†æ/kubectl-ai-mcp-cherry-studio-config.png)

æ•ˆæœå¦‚ä¸‹ï¼š
![kubectl-ai-mcp-demo](src/assets/blog-images/kubectl-aié¡¹ç›®åˆ†æ/kubectl-ai-mcp-demo.png)

---

## åŸç†åˆ†æ

### äº¤äº’æ¨¡å¼æ•´ä½“æ€è·¯

1. æ¥æ”¶ç”¨æˆ·è¾“å…¥ï¼ˆæ„å›¾ï¼‰
2. åˆ©ç”¨LLMè§£æå¹¶æ¨ç†ç”¨æˆ·æ„å›¾ï¼Œç”Ÿæˆå·¥å…·è°ƒç”¨å‘½ä»¤
3. æ‰§è¡ŒLLMç”Ÿæˆçš„å·¥å…·ï¼ˆkubectl, trivy, bash, è‡ªå®šä¹‰å·¥å…·ï¼‰
4. ç»“æ„åŒ–å±•ç¤ºç»“æœ

**æ ¸å¿ƒæ¨¡å—ä»‹ç»**
<Mermaid>
```mermaid
flowchart TB
    subgraph llms
        direction TB
        openai
        gemini
        grok
        ollama
    end
    subgraph tools
        direction TB
        Bash
        Kubectl
        Trivy
        CustomTools["Custom tools"]
    end
    User --> Chat["Chat Agent"]
    Chat --> llms & tools
    tools --> K8S["Kubernetes Cluster"]
```
</Mermaid>

1. Chat Agent æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ¢çº½ï¼Œè´Ÿè´£æ¥æ”¶ç”¨æˆ·è¾“å…¥ï¼Œç”Ÿæˆç³»ç»Ÿæç¤ºæ­¤ï¼Œè°ƒç”¨LLMè¿›è¡Œæ¨ç†ï¼Œæ‰§è¡Œå·¥å…·ï¼Œå¹¶å±•ç¤ºç»“æœã€‚
2. LLM è´Ÿè´£è§£æç”¨æˆ·è¾“å…¥ï¼Œç”Ÿæˆå·¥å…·è°ƒç”¨å‘½ä»¤ï¼Œç»“æ„åŒ–å‘½ä»¤ç»“æœã€‚
3. Tools å®šä¹‰å¹¶è´Ÿè´£æ‰§è¡Œ


**æç¤ºè¯åˆ†æ**

```
You are `kubectl-ai`, an AI assistant with expertise in operating and performing actions against a kubernetes cluster. Your task is to assist with kubernetes-related questions, debugging, performing actions on user's kubernetes cluster.

{{if .EnableToolUseShim }}
## Available tools
<tools>
{{.ToolsAsJSON}}
</tools>

## Instructions:
1. Analyze the query, previous reasoning steps, and observations.
2. Reflect on 5-7 different ways to solve the given query or task. Think carefully about each solution before picking the best one. If you haven't solved the problem completely, and have an option to explore further, or require input from the user, try to proceed without user's input because you are an autonomous agent.
3. Decide on the next action: use a tool or provide a final answer and respond in the following JSON format:

If you need to use a tool:
//```json
{
    "thought": "Your detailed reasoning about what to do next",
    "action": {
        "name": "Tool name ({{.ToolNames}})",
        "reason": "Explanation of why you chose this tool (not more than 100 words)",
        "command": "Complete command to be executed. For example, 'kubectl get pods', 'kubectl get ns'",
        "modifies_resource": "Whether the command modifies a kubernetes resource. Possible values are 'yes' or 'no' or 'unknown'"
    }
}
//```

If you have enough information to answer the query:
//```
{
    "thought": "Your final reasoning process",
    "answer": "Your comprehensive answer to the query"
}
//```
{{else}}
## Instructions:
- Examine current state of kubernetes resources relevant to user's query.
- Analyze the query, previous reasoning steps, and observations.
- Reflect on 5-7 different ways to solve the given query or task. Think carefully about each solution before picking the best one. If you haven't solved the problem completely, and have an option to explore further, or require input from the user, try to proceed without user's input because you are an autonomous agent.
- Decide on the next action: use a tool or provide a final answer.
{{end}}


## Remember:
- Fetch current state of kubernetes resources relevant to user's query.
- Prefer the tool usage that does not require any interactive input.
- For creating new resources, try to create the resource using the tools available. DO NOT ask the user to create the resource.
- Use tools when you need more information. Do not respond with the instructions on how to use the tools or what commands to run, instead just use the tool.
- Provide a final answer only when you're confident you have sufficient information.
- Provide clear, concise, and accurate responses.
- Feel free to respond with emojis where appropriate.

```

æç¤ºè¯æ•´ä½“ä¸Šéµå¾ªäº†ReActçš„æ€è·¯ã€‚

ä»æç¤ºè¯å¯ä»¥çœ‹åˆ°è¿™é‡Œä½¿ç”¨äº†golangæ¨¡ç‰ˆè¯­æ³•ï¼Œæ ¹æ®`EnableToolUseShim` å˜é‡æ¥å†³å®šæ˜¯å¦ä½¿ç”¨å·¥å…·ã€‚

```go title="pkg/agent/conversation.go"
if !s.EnableToolUseShim {
    var functionDefinitions []*gollm.FunctionDefinition
    for _, tool := range s.Tools.AllTools() {
        functionDefinitions = append(functionDefinitions, tool.FunctionDefinition())
    }
    // Sort function definitions to help KV cache reuse
    sort.Slice(functionDefinitions, func(i, j int) bool {
        return functionDefinitions[i].Name < functionDefinitions[j].Name
    })
    if err := s.llmChat.SetFunctionDefinitions(functionDefinitions); err != nil {
        return fmt.Errorf("setting function definitions: %w", err)
    }
}
```
æ ¹æ®`conversation.go`ä¸­çš„ä»£ç é€»è¾‘å¯ä»¥çœ‹åˆ°
- å¦‚æœ`EnableToolUseShim`ä¸ºfalseï¼Œåˆ™å°†å·¥å…·çš„å‡½æ•°å®šä¹‰è®¾ç½®åˆ°LLMä¸­ï¼Œé€šè¿‡function callçš„æ–¹å¼è°ƒç”¨å·¥å…·ã€‚
- å¦åˆ™å·¥å…·å£°æ˜åœ¨æç¤ºè¯ä¸­ï¼Œé€šè¿‡`<tools>`æ ‡ç­¾å£°æ˜ï¼ŒLLMä¼šæ ¹æ®æç¤ºè¯ä¸­çš„å·¥å…·å£°æ˜æ¥è°ƒç”¨å·¥å…·ã€‚


### MCPæ¨¡å¼

é€šè¿‡ `github.com/mark3labs/mcp-go/mcp` åŒ…èƒ½å¤Ÿå¿«é€Ÿå®ç°MCPæœåŠ¡ã€‚åªéœ€è¦å®šä¹‰å¥½å·¥å…·å³å¯ï¼Œå¹¶ä¸éœ€è¦ç¼–å†™æç¤ºè¯å’Œé…ç½®LLMã€‚

```go title="cmd/mcp.go"
package main

import (
	"context"
	"fmt"
	"github.com/GoogleCloudPlatform/kubectl-ai/pkg/tools"
	"github.com/mark3labs/mcp-go/mcp"
	"github.com/mark3labs/mcp-go/server"
	"k8s.io/klog/v2"
)

type kubectlMCPServer struct {
	kubectlConfig string
	server        *server.MCPServer
	tools         tools.Tools
	workDir       string
}

func newKubectlMCPServer(ctx context.Context, kubectlConfig string, tools tools.Tools, workDir string) (*kubectlMCPServer, error) {
	s := &kubectlMCPServer{
		kubectlConfig: kubectlConfig,
		workDir:       workDir,
		server: server.NewMCPServer(
			"kubectl-ai",
			"0.0.1",
			server.WithToolCapabilities(true),
		),
		tools: tools,
	}
	for _, tool := range s.tools.AllTools() {
		toolDefn := tool.FunctionDefinition()
		toolInputSchema, err := toolDefn.Parameters.ToRawSchema()
		if err != nil {
			return nil, fmt.Errorf("converting tool schema to json.RawMessage: %w", err)
		}
		s.server.AddTool(mcp.NewToolWithRawSchema(
			toolDefn.Name,
			toolDefn.Description,
			toolInputSchema,
		), s.handleToolCall)
	}
	return s, nil
}
func (s *kubectlMCPServer) Serve(ctx context.Context) error {
	return server.ServeStdio(s.server)
}

func (s *kubectlMCPServer) handleToolCall(ctx context.Context, request mcp.CallToolRequest) (*mcp.CallToolResult, error) {

	log := klog.FromContext(ctx)

	name := request.Params.Name
	command := request.Params.Arguments["command"].(string)
	modifiesResource := request.Params.Arguments["modifies_resource"].(string)
	log.Info("Received tool call", "tool", name, "command", command, "modifies_resource", modifiesResource)

	ctx = context.WithValue(ctx, tools.KubeconfigKey, s.kubectlConfig)
	ctx = context.WithValue(ctx, tools.WorkDirKey, s.workDir)

	tool := tools.Lookup(name)
	if tool == nil {
		return &mcp.CallToolResult{
			Content: []mcp.Content{
				mcp.TextContent{
					Type: "text",
					Text: fmt.Sprintf("Error: Tool %s not found", name),
				},
			},
		}, nil
	}
	output, err := tool.Run(ctx, map[string]any{
		"command": command,
	})
	if err != nil {
		log.Error(err, "Error running tool call")
		return &mcp.CallToolResult{
			Content: []mcp.Content{
				mcp.TextContent{
					Type: "text",
					Text: fmt.Sprintf("Error: %v", err),
				},
			},
			IsError: true,
		}, nil
	}

	result, err := tools.ToolResultToMap(output)
	if err != nil {
		log.Error(err, "Error converting tool call output to result")
		return &mcp.CallToolResult{
			Content: []mcp.Content{
				mcp.TextContent{
					Type: "text",
					Text: fmt.Sprintf("Error: %v", err),
				},
			},
			IsError: true,
		}, nil
	}

	log.Info("Tool call output", "tool", name, "result", result)

	return &mcp.CallToolResult{
		Content: []mcp.Content{
			mcp.TextContent{
				Type: "text",
				Text: fmt.Sprintf("%v", result),
			},
		},
	}, nil
}

```

---

## ä¼˜ç¼ºç‚¹åˆ†æ

1. ä¼˜ç‚¹

    - é€šè¿‡è‡ªç„¶è¯­è¨€äº¤äº’ï¼Œå¯ä»¥åšåˆ°å£°æ˜å¼æ“ä½œï¼Œæˆ–è€…é™ä½ç¼–å†™yamlçš„é—¨æ§›
    - å¯ä»¥ä½œä¸ºMCPæœåŠ¡ä½¿ç”¨ï¼Œæ–¹ä¾¿é›†æˆåˆ°å…¶ä»–å·¥å…·ä¸­
    - æ”¯æŒå¤šç§LLMæ¨¡å‹ï¼Œæ–¹ä¾¿ç”¨æˆ·é€‰æ‹©
    - æ”¯æŒè‡ªå®šä¹‰å·¥å…·ï¼Œæ¯”å¦‚helm

2. ç¼ºç‚¹

    - ä½œä¸ºMCPæœåŠ¡ï¼Œä¸èƒ½åŒæ—¶ç®¡ç†å¤šä¸ªé›†ç¾¤ï¼Œå¯èƒ½éœ€è¦è‡ªå®šä¹‰å¤šé›†ç¾¤ç®¡ç†å·¥å…·
    - å¯¹äºç†Ÿç»ƒå·¥æ¥è¯´ï¼Œç¼–å†™æç¤ºè¯å¯èƒ½æ¯”ç›´æ¥ç¼–å†™kubectlå‘½ä»¤æ›´éº»çƒ¦(ä¸¥æ ¼ä¸Šè¯´ä¸æ˜¯å·¥å…·çš„é—®é¢˜)
    - é»˜è®¤çš„ç³»ç»Ÿæç¤ºè¯ä¸ä¼šè¯¦ç»†è§£é‡Šllmç”Ÿæˆçš„å‘½ä»¤ã€‚
    - ç¼ºå°‘å†å²è®°å½•åŠŸèƒ½ï¼Œä¸èƒ½æŸ¥çœ‹ä¹‹å‰çš„äº¤äº’ï¼Œæˆ–è€…ç»§ç»­ä¹‹å‰çš„äº¤äº’
